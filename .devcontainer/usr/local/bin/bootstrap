#!/usr/bin/env bash
set -Eeuo pipefail

WORKSPACE_ROOT="${WORKSPACE_ROOT:-${CODESPACE_VSCODE_FOLDER:-${GITHUB_WORKSPACE:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)}}}"
BOOTSTRAP_DIR="${BOOTSTRAP_DIR:-$WORKSPACE_ROOT/bootstrap.d}"

if minikube status >/dev/null 2>&1; then
  echo "âœ… Minikube already running"
else
  echo "ðŸš€ Starting Minikube..."
  minikube start \
    --driver docker \
    --mount \
    --mount-string="/workspaces:/workspaces" \
    --addons=ingress \
    --addons=ingress-dns \
    --wait=apiserver,system_pods,default_sa \
    --wait-timeout=180s
fi

echo "ðŸš€ Bootstrapping..."
exec helmfile apply -q --suppress-diff -f ${BOOTSTRAP_DIR}
